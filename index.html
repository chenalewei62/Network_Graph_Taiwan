<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台灣政壇網絡 (Live Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #f8fafc; user-select: none; -webkit-user-select: none; touch-action: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // 重要：請在此處填入您的 Firebase Config
        // ==========================================
        // 1. 前往 Firebase Console -> Project Settings
        // 2. 複製您的 web app config 物件
        // 3. 替換掉下方的空物件 {} (請保留 JSON.parse 的結構，或者直接用 const firebaseConfig = { ... };)
        


        // [範例] 如果您的環境變數無效，請取消註解下方並填入資料：
        
const firebaseConfig = {
  apiKey: "AIzaSyCRaOhX4vCcsKLCFtUfFw0B1Ce2NnHF0mA",
  authDomain: "political-actor-mapping.firebaseapp.com",
  projectId: "political-actor-mapping",
  storageBucket: "political-actor-mapping.firebasestorage.app",
  messagingSenderId: "232784260710",
  appId: "1:232784260710:web:496a6da06cfe90f77007a7",
  measurementId: "G-H6B9N45HJ1"
};
        // 初始化 Firebase
        if (!firebase.apps.length && firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase init error", e);
                alert("Firebase 初始化失敗: " + e.message);
            }
        } else if (!firebaseConfig.apiKey) {
            console.warn("Firebase Config is missing!");
        }

        const auth = firebase.apps.length ? firebase.auth() : null;
        const db = firebase.apps.length ? firebase.firestore() : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- Constants ---
        const PARTIES = {
            DPP: { color: "#1B9431", label: "民進黨" },
            KMT: { color: "#000095", label: "國民黨" },
            TPP: { color: "#28C7C7", label: "民眾黨" },
            OTHER: { color: "#666666", label: "無黨/其他" },
        };

        const RELATIONSHIPS = {
            FRIENDLY: { id: 'FRIENDLY', label: '友好', color: '#10b981', width: 3, distance: 80, dashed: "0" },
            HOSTILE: { id: 'HOSTILE', label: '敵對', color: '#ef4444', width: 2, distance: 220, dashed: "6,4" },
            COOPERATIVE: { id: 'COOPERATIVE', label: '合作', color: '#3b82f6', width: 2, distance: 130, dashed: "0" }
        };

        const INITIAL_DATA = {
            nodes: [
                { tempId: 1, name: "賴清德", party: "DPP", x: 0, y: 0 },
                { tempId: 2, name: "蕭美琴", party: "DPP", x: 120, y: -60 },
                { tempId: 3, name: "韓國瑜", party: "KMT", x: -120, y: 80 },
                { tempId: 4, name: "柯文哲", party: "TPP", x: 80, y: 120 },
                { tempId: 5, name: "卓榮泰", party: "DPP", x: 60, y: -120 },
                { tempId: 6, name: "黃國昌", party: "TPP", x: 140, y: 160 },
                { tempId: 7, name: "盧秀燕", party: "KMT", x: -160, y: 40 },
                { tempId: 8, name: "王世堅", party: "DPP", x: -50, y: 150 },
            ],
            links: [
                { source: 1, target: 2, type: "FRIENDLY" },
                { source: 1, target: 5, type: "COOPERATIVE" },
                { source: 1, target: 3, type: "HOSTILE" },
                { source: 1, target: 4, type: "HOSTILE" },
                { source: 4, target: 6, type: "FRIENDLY" },
                { source: 3, target: 7, type: "COOPERATIVE" },
                { source: 3, target: 4, type: "COOPERATIVE" },
                { source: 4, target: 8, type: "HOSTILE" },
                { source: 1, target: 8, type: "COOPERATIVE" },
            ]
        };

        const Icon = ({ d, size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Icons = {
            Plus: (p) => <Icon {...p} d="M12 5v14M5 12h14" />,
            Link: (p) => <Icon {...p} d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
            Trash: (p) => <Icon {...p} d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Menu: (p) => <Icon {...p} d="M3 12h18M3 6h18M3 18h18" />,
            Search: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
            Cloud: (p) => <Icon {...p} d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />,
            Database: (p) => <Icon {...p} d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M21 12c0-1.66-4-3-9-3s-9 1.34-9 3m0-6C3 9 3 5 12 5s9 4 9 4M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />,
            Download: (p) => <Icon {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            List: (p) => <Icon {...p} d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
            ZoomIn: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />,
            ZoomOut: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM7 10h6" />,
            Refresh: (p) => <Icon {...p} d="M1 4v6h6M23 20v-6h-6M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />,
            Move: (p) => <Icon {...p} d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M9 19l3 3 3 3M2 12h20M12 2v20" />,
            Star: (p) => <Icon {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
            Alert: (p) => <Icon {...p} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />
        };

        function App() {
            // --- Config Check ---
            const isConfigValid = useMemo(() => firebaseConfig && firebaseConfig.apiKey, []);

            const [user, setUser] = useState(null);
            const [nodes, setNodes] = useState([]);
            const [links, setLinks] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // UI State - Detect mobile on init
            const isMobile = useMemo(() => window.innerWidth < 768, []);
            const [activeTab, setActiveTab] = useState('add_person');
            const [leftSidebarOpen, setLeftSidebarOpen] = useState(!isMobile);
            const [rightSidebarOpen, setRightSidebarOpen] = useState(false);
            
            const [searchTerm, setSearchTerm] = useState("");
            const [scale, setScale] = useState(isMobile ? 0.6 : 1);
            const [offset, setOffset] = useState({ x: window.innerWidth/2, y: window.innerHeight/2 });
            const [isPanning, setIsPanning] = useState(false);
            const [selectedNodeId, setSelectedNodeId] = useState(null);

            // Form State
            const [newName, setNewName] = useState("");
            const [newParty, setNewParty] = useState("DPP");
            const [linkSource, setLinkSource] = useState("");
            const [linkTarget, setLinkTarget] = useState("");
            const [linkType, setLinkType] = useState("COOPERATIVE");

            const svgRef = useRef(null);
            const draggingRef = useRef(null);
            const panRef = useRef(null);
            const hasAutoSeededRef = useRef(false);

            useEffect(() => {
                if (!isConfigValid) return;

                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            // 請確保 Firebase Console -> Authentication -> Sign-in method -> Anonymous 已啟用
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Auth failed", error);
                        alert("登入失敗：請檢查 Firebase Console 是否已開啟「匿名登入 (Anonymous)」功能。\n錯誤訊息: " + error.message);
                    }
                };
                init();
                return auth.onAuthStateChanged(u => setUser(u));
            }, [isConfigValid]);

            const seedDatabase = async () => {
                if (hasAutoSeededRef.current) return;
                hasAutoSeededRef.current = true;
                const batch = db.batch();
                const nodesRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes');
                const linksRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links');
                const idMap = {}; 
                try {
                    INITIAL_DATA.nodes.forEach(n => {
                        const docRef = nodesRef.doc(); idMap[n.tempId] = docRef.id;
                        batch.set(docRef, { name: n.name, party: n.party, x: n.x, y: n.y, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    INITIAL_DATA.links.forEach(l => {
                        const docRef = linksRef.doc();
                        batch.set(docRef, { source: idMap[l.source], target: idMap[l.target], type: l.type, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    await batch.commit();
                    console.log("Auto-seed completed");
                } catch (err) { 
                    console.error("Auto-seed failed", err); 
                    alert("自動寫入範例資料失敗: " + err.message);
                }
            };

            useEffect(() => {
                if (!user) return;
                
                // Listen to Nodes
                const unsubscribeNodes = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes')
                    .onSnapshot(snapshot => {
                        if (snapshot.empty && !hasAutoSeededRef.current) { seedDatabase(); return; }
                        const loadedNodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setNodes(prevNodes => loadedNodes.map(loaded => {
                            const existing = prevNodes.find(p => p.id === loaded.id);
                            return { ...loaded, x: existing ? existing.x : (loaded.x || (Math.random()-0.5)*200), y: existing ? existing.y : (loaded.y || (Math.random()-0.5)*200), vx: existing ? existing.vx : 0, vy: existing ? existing.vy : 0, radius: 15 };
                        }));
                        setLoading(false);
                        if (loadedNodes.length > 0 && !linkSource) setLinkSource(loadedNodes[0].id);
                    }, error => {
                        console.error("Node snapshot error", error);
                        alert("讀取資料失敗，可能是權限不足。請檢查 Firestore Rules。\n" + error.message);
                    });

                // Listen to Links
                const unsubscribeLinks = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links')
                    .onSnapshot(snapshot => {
                         setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, error => console.error("Link snapshot error", error));

                return () => { unsubscribeNodes(); unsubscribeLinks(); };
            }, [user]);

            useEffect(() => {
                let animationFrameId;
                const linkCounts = {};
                links.forEach(l => { linkCounts[l.source] = (linkCounts[l.source]||0)+1; linkCounts[l.target] = (linkCounts[l.target]||0)+1; });
                const maxLinks = Math.max(...Object.values(linkCounts), 1);
                const MIN_RADIUS = 12; const MAX_RADIUS = 60;

                const step = () => {
                    setNodes(currentNodes => {
                        const newNodes = currentNodes.map(n => ({ ...n }));
                        const forces = newNodes.map(() => ({ fx: 0, fy: 0 }));
                        newNodes.forEach(n => {
                            const count = linkCounts[n.id] || 0;
                            const ratio = maxLinks > 0 ? count / maxLinks : 0;
                            n.radius = MIN_RADIUS + (ratio * (MAX_RADIUS - MIN_RADIUS));
                        });
                        for (let i = 0; i < newNodes.length; i++) {
                            for (let j = i + 1; j < newNodes.length; j++) {
                                const dx = newNodes[i].x - newNodes[j].x;
                                const dy = newNodes[i].y - newNodes[j].y;
                                let distSq = dx * dx + dy * dy || 1;
                                const dist = Math.sqrt(distSq);
                                const force = 8000 / distSq;
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;
                                forces[i].fx += fx; forces[i].fy += fy;
                                forces[j].fx -= fx; forces[j].fy -= fy;
                            }
                        }
                        links.forEach(link => {
                            const sIdx = newNodes.findIndex(n => n.id === link.source);
                            const tIdx = newNodes.findIndex(n => n.id === link.target);
                            if (sIdx !== -1 && tIdx !== -1) {
                                const rel = RELATIONSHIPS[link.type] || RELATIONSHIPS.COOPERATIVE;
                                const dx = newNodes[tIdx].x - newNodes[sIdx].x;
                                const dy = newNodes[tIdx].y - newNodes[sIdx].y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const combinedRadius = newNodes[sIdx].radius + newNodes[tIdx].radius;
                                const targetDist = Math.max(rel.distance, combinedRadius * 1.2);
                                const force = (dist - targetDist) * 0.08;
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;
                                forces[sIdx].fx += fx; forces[sIdx].fy += fy;
                                forces[tIdx].fx -= fx; forces[tIdx].fy -= fy;
                            }
                        });
                        newNodes.forEach((node, i) => {
                            if (draggingRef.current && draggingRef.current.id === node.id) {
                                if (typeof draggingRef.current.x === 'number') { node.x = draggingRef.current.x; node.y = draggingRef.current.y; }
                                node.vx = 0; node.vy = 0;
                            } else {
                                forces[i].fx -= node.x * 0.01; forces[i].fy -= node.y * 0.01;
                                node.vx = (node.vx + forces[i].fx) * 0.85; node.vy = (node.vy + forces[i].fy) * 0.85;
                                node.x += node.vx; node.y += node.vy;
                            }
                        });
                        return newNodes;
                    });
                    animationFrameId = requestAnimationFrame(step);
                };
                animationFrameId = requestAnimationFrame(step);
                return () => cancelAnimationFrame(animationFrameId);
            }, [links, nodes.length]);

            const handleAddNode = async (e) => {
                e.preventDefault();
                if (!newName.trim() || !user) {
                    if(!user) alert("尚未連線到資料庫，請檢查設定或網路");
                    return;
                }
                if (nodes.length > 0 && !linkSource) { alert("請選擇連結對象"); return; }
                const isDuplicate = nodes.some(n => n.name === newName.trim());
                if (isDuplicate) { alert(`人物「${newName}」已存在！`); setActiveTab('add_link'); return; }
                try {
                    const sourceNode = nodes.find(n => n.id === linkSource);
                    const startX = sourceNode ? sourceNode.x + (Math.random()-0.5)*50 : 0;
                    const startY = sourceNode ? sourceNode.y + (Math.random()-0.5)*50 : 0;
                    const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').add({
                        name: newName.trim(), party: newParty, x: startX, y: startY, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    if (linkSource) {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').add({
                            source: linkSource, target: docRef.id, type: linkType, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    setNewName(""); setLinkSource(docRef.id);
                    if (window.innerWidth < 768) setLeftSidebarOpen(false);
                } catch (err) { 
                    console.error(err);
                    alert("新增失敗: " + err.message);
                }
            };

            const handleAddLink = async (e) => {
                e.preventDefault();
                if (!linkSource || !linkTarget || linkSource === linkTarget) { alert("請選擇兩個不同的人物"); return; }
                const exists = links.some(l => (l.source === linkSource && l.target === linkTarget) || (l.source === linkTarget && l.target === linkSource));
                if (exists) { alert("連結已存在"); return; }
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').add({
                        source: linkSource, target: linkTarget, type: linkType, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    if (window.innerWidth < 768) setLeftSidebarOpen(false);
                } catch (err) { console.error(err); alert("新增連結失敗: " + err.message); }
            };

            const handleDelete = async (id) => {
                if(!confirm("確定要刪除？")) return;
                try {
                    const batch = db.batch();
                    batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').doc(id));
                    links.filter(l => l.source === id || l.target === id).forEach(l => {
                        batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').doc(l.id));
                    });
                    await batch.commit();
                    setSelectedNodeId(null);
                } catch (err) { console.error(err); alert("刪除失敗: " + err.message); }
            };

            // --- Unified Interaction (Mouse & Touch) ---
            const startDragNode = (id, clientX, clientY) => {
                draggingRef.current = { id, startX: clientX, startY: clientY, nodeX: nodes.find(n => n.id === id).x, nodeY: nodes.find(n => n.id === id).y, x: nodes.find(n => n.id === id).x, y: nodes.find(n => n.id === id).y };
                setSelectedNodeId(id);
            };
            const startPanCanvas = (clientX, clientY) => {
                setIsPanning(true);
                panRef.current = { startX: clientX, startY: clientY, startOffsetX: offset.x, startOffsetY: offset.y };
            };
            const handleMouseDown = (e, node) => { e.stopPropagation(); startDragNode(node.id, e.clientX, e.clientY); };
            const handleCanvasMouseDown = (e) => { startPanCanvas(e.clientX, e.clientY); };
            const handleTouchStartNode = (e, node) => { e.stopPropagation(); const touch = e.touches[0]; startDragNode(node.id, touch.clientX, touch.clientY); };
            const handleCanvasTouchStart = (e) => { const touch = e.touches[0]; startPanCanvas(touch.clientX, touch.clientY); };

            useEffect(() => {
                const handleMove = (clientX, clientY) => {
                    if (draggingRef.current) {
                        const dx = (clientX - draggingRef.current.startX) / scale;
                        const dy = (clientY - draggingRef.current.startY) / scale;
                        draggingRef.current.x = draggingRef.current.nodeX + dx;
                        draggingRef.current.y = draggingRef.current.nodeY + dy;
                    } else if (panRef.current) {
                        const dx = clientX - panRef.current.startX;
                        const dy = clientY - panRef.current.startY;
                        setOffset({ x: panRef.current.startOffsetX + dx, y: panRef.current.startOffsetY + dy });
                    }
                };
                const handleUp = async () => {
                    if (draggingRef.current) {
                        const { id, x, y } = draggingRef.current;
                        if (id && !isNaN(x) && !isNaN(y)) {
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').doc(id).update({ x, y }).catch(console.error);
                        }
                        draggingRef.current = null;
                    }
                    panRef.current = null;
                    setIsPanning(false);
                };
                const onMouseMove = (e) => handleMove(e.clientX, e.clientY);
                const onMouseUp = () => handleUp();
                const onTouchMove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY);
                const onTouchEnd = () => handleUp();
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
                window.addEventListener('touchmove', onTouchMove);
                window.addEventListener('touchend', onTouchEnd);
                return () => { 
                    window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp);
                    window.removeEventListener('touchmove', onTouchMove); window.removeEventListener('touchend', onTouchEnd);
                };
            }, [scale, offset, nodes]);

            const zoomIn = () => setScale(s => Math.min(s * 1.2, 5));
            const zoomOut = () => setScale(s => Math.max(s / 1.2, 0.1));
            const resetView = () => { setScale(isMobile ? 0.6 : 1); setOffset({ x: window.innerWidth/2, y: window.innerHeight/2 }); };

            const sortedNodes = useMemo(() => [...nodes].sort((a,b) => a.name.localeCompare(b.name)), [nodes]);

            // --- Config Check Render ---
            if (!isConfigValid) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-red-50 p-5">
                        <div className="max-w-md bg-white p-8 rounded-xl shadow-xl border border-red-200 text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icons.Alert size={32} className="text-red-500" />
                            </div>
                            <h2 className="text-2xl font-bold text-red-800 mb-2">尚未設定資料庫連線</h2>
                            <p className="text-gray-600 mb-6 text-sm leading-relaxed">
                                您目前使用的是下載後的靜態檔案，為了讓多人協作功能運作，請使用純文字編輯器 (如 Notepad) 打開此 HTML 檔案，搜尋 
                                <code className="bg-gray-100 px-1 py-0.5 rounded text-red-600 font-mono mx-1">const firebaseConfig</code>
                                並填入您從 Firebase Console 取得的金鑰。
                            </p>
                            <div className="text-xs text-gray-400 border-t border-gray-100 pt-4">
                                若您是在預覽環境看到此訊息，請重新整理頁面。
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen w-full bg-slate-50 overflow-hidden font-sans text-slate-800">
                    {/* Left Sidebar */}
                    <div className={`absolute z-30 left-0 top-0 h-full shadow-2xl transition-transform duration-300 flex flex-col glass-panel border-r border-slate-200 
                        w-full sm:w-80 
                        ${leftSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}
                    >
                        <div className="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md shrink-0">
                            <h1 className="font-bold text-lg flex items-center gap-2"><Icons.Cloud size={20}/> 雲端政壇觀測</h1>
                            <div className="flex items-center gap-2">
                                {loading && <span className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>}
                                <button onClick={() => setLeftSidebarOpen(false)} className="hover:bg-slate-700 p-2 rounded"><Icons.X size={24}/></button>
                            </div>
                        </div>

                        <div className="flex p-2 gap-2 bg-slate-100 border-b border-slate-200 shrink-0">
                            <button onClick={() => setActiveTab('add_person')} className={`flex-1 py-3 sm:py-2 text-xs font-bold rounded flex items-center justify-center gap-1 ${activeTab === 'add_person' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}><Icons.Plus size={16}/> 新增人物</button>
                            <button onClick={() => setActiveTab('add_link')} className={`flex-1 py-3 sm:py-2 text-xs font-bold rounded flex items-center justify-center gap-1 ${activeTab === 'add_link' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}><Icons.Link size={16}/> 連結現有</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-6 pb-20 sm:pb-4">
                            {activeTab === 'add_person' && (
                                <form onSubmit={handleAddNode} className="space-y-4 fade-in">
                                    <div><label className="text-xs font-bold text-slate-400 mb-1 block">新人物姓名</label><input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="例: 王世堅" className="w-full p-3 sm:p-2 rounded border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-base sm:text-sm" /></div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 mb-1 block">所屬政黨</label>
                                        <div className="grid grid-cols-2 gap-2">{Object.entries(PARTIES).map(([k, v]) => (<button type="button" key={k} onClick={() => setNewParty(k)} className={`text-xs py-2 px-2 rounded border ${newParty === k ? 'ring-2 ring-offset-1 font-bold' : 'opacity-70'}`} style={{ backgroundColor: newParty === k ? v.color : '#fff', color: newParty === k ? '#fff' : '#333', borderColor: v.color }}>{v.label}</button>))}</div>
                                    </div>
                                    {nodes.length > 0 ? (
                                        <div className="p-3 bg-blue-50 rounded border border-blue-100">
                                            <label className="text-xs font-bold text-blue-800 mb-1 block">初始連結對象</label>
                                            <select value={linkSource} onChange={e => setLinkSource(e.target.value)} className="w-full p-3 sm:p-2 mb-3 rounded border border-blue-200 text-base sm:text-sm"><option value="" disabled>-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}</select>
                                            <div className="flex gap-1">{Object.values(RELATIONSHIPS).map(r => (<button type="button" key={r.id} onClick={() => setLinkType(r.id)} className={`flex-1 py-2 text-[10px] rounded border ${linkType === r.id ? 'text-white' : 'bg-white'}`} style={{ backgroundColor: linkType === r.id ? r.color : '#fff', borderColor: r.color, color: linkType === r.id ? '#fff' : r.color }}>{r.label}</button>))}</div>
                                        </div>
                                    ) : <div className="p-3 bg-green-50 rounded border border-green-200 text-green-800 text-xs font-bold mb-2 flex items-center gap-2"><Icons.Star size={16} className="text-green-600"/><span>第一位核心人物</span></div>}
                                    <button type="submit" disabled={!newName.trim() || (nodes.length > 0 && !linkSource)} className="w-full py-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:opacity-50 font-bold text-base">{nodes.length === 0 ? "建立起點" : "加入網絡"}</button>
                                </form>
                            )}
                            {activeTab === 'add_link' && (
                                <form onSubmit={handleAddLink} className="space-y-4 fade-in">
                                    {nodes.length < 2 ? <div className="p-4 text-center text-slate-400 text-xs">需至少兩位人物</div> : (
                                        <div className="p-4 bg-purple-50 rounded border border-purple-100 space-y-3">
                                            <div><label className="text-xs font-bold text-purple-800 mb-1 block">人物 A</label><select value={linkSource} onChange={e => setLinkSource(e.target.value)} className="w-full p-3 sm:p-2 rounded border border-purple-200 text-base sm:text-sm"><option value="">-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id} disabled={n.id === linkTarget}>{n.name}</option>)}</select></div>
                                            <div><label className="text-xs font-bold text-purple-800 mb-1 block">人物 B</label><select value={linkTarget} onChange={e => setLinkTarget(e.target.value)} className="w-full p-3 sm:p-2 rounded border border-purple-200 text-base sm:text-sm"><option value="">-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id} disabled={n.id === linkSource}>{n.name}</option>)}</select></div>
                                            <div><label className="text-xs font-bold text-purple-800 mb-1 block">關係性質</label><div className="flex gap-1">{Object.values(RELATIONSHIPS).map(r => (<button type="button" key={r.id} onClick={() => setLinkType(r.id)} className={`flex-1 py-2 text-[10px] rounded border ${linkType === r.id ? 'text-white' : 'bg-white'}`} style={{ backgroundColor: linkType === r.id ? r.color : '#fff', borderColor: r.color, color: linkType === r.id ? '#fff' : r.color }}>{r.label}</button>))}</div></div>
                                        </div>
                                    )}
                                    <button type="submit" disabled={!linkSource || !linkTarget} className="w-full py-3 bg-purple-600 text-white rounded shadow hover:bg-purple-700 disabled:opacity-50 font-bold text-base">建立連結</button>
                                </form>
                            )}
                            {selectedNodeId && nodes.find(n => n.id === selectedNodeId) && (
                                <div className="border-t pt-4 mt-4 pb-20 sm:pb-0">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-sm text-slate-600">選取資訊</h3>
                                        <button onClick={() => handleDelete(selectedNodeId)} className="text-red-500 p-2 bg-red-50 rounded-full hover:bg-red-100"><Icons.Trash size={20}/></button>
                                    </div>
                                    <div className="p-4 bg-white rounded border shadow-sm">
                                        <div className="text-xl font-bold mb-1">{nodes.find(n => n.id === selectedNodeId).name}</div>
                                        <div className="text-xs bg-slate-100 p-2 rounded">連結數: {links.filter(l => l.source === selectedNodeId || l.target === selectedNodeId).length}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {!leftSidebarOpen && (
                        <button onClick={() => { setLeftSidebarOpen(true); setRightSidebarOpen(false); }} 
                                className="absolute top-4 left-4 z-20 bg-white p-3 rounded shadow-lg border border-slate-100 active:bg-slate-100">
                            <Icons.Menu size={24} />
                        </button>
                    )}

                    {/* Right Sidebar */}
                    <div className={`absolute z-30 right-0 top-0 h-full shadow-xl transition-transform duration-300 flex flex-col glass-panel border-l border-slate-200 
                        w-full sm:w-64 
                        ${rightSidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}
                    >
                        <div className="p-3 bg-slate-800 text-white flex justify-between items-center shadow-sm shrink-0">
                            <h2 className="font-bold text-sm flex items-center gap-2"><Icons.List size={16}/> 人物名單 ({nodes.length})</h2>
                            <button onClick={() => setRightSidebarOpen(false)} className="hover:bg-slate-700 p-2 rounded"><Icons.X size={24}/></button>
                        </div>
                        <div className="p-2 border-b border-slate-200 bg-slate-50 shrink-0"><div className="relative"><Icons.Search size={18} className="absolute left-3 top-3 text-slate-400"/><input type="text" placeholder="搜尋姓名..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-3 py-2 rounded border border-slate-300 text-sm focus:ring-1 focus:ring-blue-500 outline-none"/></div></div>
                        <div className="flex-1 overflow-y-auto p-2 custom-scrollbar pb-20 sm:pb-2">
                            {Object.entries(PARTIES).map(([partyKey, partyInfo]) => {
                                const partyNodes = sortedNodes.filter(n => n.party === partyKey && n.name.includes(searchTerm));
                                if (partyNodes.length === 0) return null;
                                return (
                                    <div key={partyKey} className="mb-4">
                                        <h3 className="text-[10px] font-bold text-slate-500 mb-2 px-2 flex items-center gap-1 uppercase tracking-wider"><span className="w-2 h-2 rounded-full" style={{background: partyInfo.color}}></span>{partyInfo.label}</h3>
                                        <div className="space-y-1">{partyNodes.map(node => (<div key={node.id} onClick={() => { setSelectedNodeId(node.id); if(window.innerWidth < 768) setRightSidebarOpen(false); }} className={`px-3 py-3 sm:py-1.5 rounded cursor-pointer flex items-center justify-between text-sm sm:text-xs transition-colors group border border-transparent ${selectedNodeId === node.id ? 'bg-blue-50 border-blue-200 text-blue-700 font-bold' : 'hover:bg-slate-100 hover:border-slate-200 text-slate-700'}`}><span>{node.name}</span><span className={`text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-400 group-hover:bg-white group-hover:text-slate-500 ${selectedNodeId === node.id ? 'bg-white text-blue-400' : ''}`}>{links.filter(l => l.source === node.id || l.target === node.id).length}</span></div>))}</div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* Main Graph Area */}
                    <div className={`flex-1 relative overflow-hidden bg-slate-50 transition-all duration-300 
                        ${!isMobile && rightSidebarOpen ? 'mr-64' : 'mr-0'} 
                        ${!isMobile && leftSidebarOpen ? 'ml-80' : 'ml-0'} 
                        ${isPanning ? 'cursor-grabbing' : 'cursor-grab'}`} 
                         onMouseDown={handleCanvasMouseDown}
                         onTouchStart={handleCanvasTouchStart}
                    >
                        <div className="absolute bottom-4 left-4 text-xs text-slate-400 pointer-events-none select-none z-10 hidden sm:block">{loading ? "Loading..." : `Live Sync • ${nodes.length} Nodes`}</div>
                        
                        <div className="absolute top-4 right-4 z-20 flex gap-2">
                             {!rightSidebarOpen && <button onClick={() => { setRightSidebarOpen(true); setLeftSidebarOpen(false); }} className="bg-white p-3 rounded shadow-lg text-slate-600 active:bg-slate-100 flex items-center gap-1 text-xs font-bold"><Icons.List size={20}/> <span className="hidden sm:inline">名單</span></button>}
                        </div>

                        <div className="absolute bottom-8 right-4 z-20 flex flex-col gap-3">
                            <div className="flex flex-col bg-white rounded-lg shadow-xl border border-slate-200 overflow-hidden">
                                <button onClick={zoomIn} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100 border-b border-slate-100"><Icons.ZoomIn size={24}/></button>
                                <button onClick={zoomOut} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100 border-b border-slate-100"><Icons.ZoomOut size={24}/></button>
                                <button onClick={resetView} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100"><Icons.Refresh size={24}/></button>
                            </div>
                        </div>

                        <svg ref={svgRef} className="w-full h-full" style={{touchAction: 'none'}} onWheel={e => setScale(s => Math.max(0.1, Math.min(5, e.deltaY > 0 ? s * 0.9 : s * 1.1)))}>
                            <g transform={`translate(${offset.x}, ${offset.y}) scale(${scale})`}>
                                {links.map(link => {
                                    const s = nodes.find(n => n.id === link.source);
                                    const t = nodes.find(n => n.id === link.target);
                                    if (!s || !t) return null;
                                    const rel = RELATIONSHIPS[link.type] || RELATIONSHIPS.COOPERATIVE;
                                    return <line key={link.id} x1={s.x} y1={s.y} x2={t.x} y2={t.y} stroke={rel.color} strokeWidth={rel.width} strokeDasharray={rel.dashed} strokeOpacity={0.6} />;
                                })}
                                {nodes.map(node => (
                                    <g key={node.id} transform={`translate(${node.x}, ${node.y})`} 
                                       onMouseDown={e => handleMouseDown(e, node)} 
                                       onTouchStart={e => handleTouchStartNode(e, node)}
                                       className="transition-opacity cursor-pointer"
                                    >
                                        {selectedNodeId === node.id && <circle r={node.radius + 10} fill="rgba(59, 130, 246, 0.3)" />}
                                        <circle r={node.radius} fill={PARTIES[node.party]?.color || "#999"} stroke={selectedNodeId === node.id ? "#3b82f6" : "white"} strokeWidth={selectedNodeId === node.id ? 4 : 2} className="shadow-sm" />
                                        <text dy={node.radius + 18} textAnchor="middle" className={`text-[12px] font-bold pointer-events-none select-none ${selectedNodeId === node.id ? 'fill-blue-600 text-lg' : 'fill-slate-700'}`} style={{textShadow: '0 1px 2px white'}}>{node.name}</text>
                                    </g>
                                ))}
                            </g>
                        </svg>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>