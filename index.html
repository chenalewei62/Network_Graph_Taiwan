<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台灣政壇網絡 (Live Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #f8fafc; user-select: none; -webkit-user-select: none; touch-action: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        
        /* Slider Styling - Spectrum Gradient */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #64748b; cursor: pointer; margin-top: -8px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; 
            background: linear-gradient(to right, #2563eb, #10b981, #eab308, #f97316, #dc2626); 
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // 重要：請在此處填入您的 Firebase Config
        // ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyCRaOhX4vCcsKLCFtUfFw0B1Ce2NnHF0mA",
  authDomain: "political-actor-mapping.firebaseapp.com",
  projectId: "political-actor-mapping",
  storageBucket: "political-actor-mapping.firebasestorage.app",
  messagingSenderId: "232784260710",
  appId: "1:232784260710:web:496a6da06cfe90f77007a7",
  measurementId: "G-

        if (!firebase.apps.length && firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase init error", e);
            }
        } else if (!firebaseConfig.apiKey) {
            console.warn("Firebase Config is missing!");
        }

        const auth = firebase.apps.length ? firebase.auth() : null;
        const db = firebase.apps.length ? firebase.firestore() : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- Constants ---
        const PARTIES = {
            DPP: { color: "#1B9431", label: "民進黨", textColor: "#FFFFFF" },
            KMT: { color: "#000095", label: "國民黨", textColor: "#FFFFFF" },
            TPP: { color: "#28C7C7", label: "民眾黨", textColor: "#0f172a" },
            OTHER: { color: "#666666", label: "無黨/其他", textColor: "#FFFFFF" },
        };

        // 10級關係光譜 (增加 distance 設定，讓圖形更寬鬆)
        const RELATIONSHIP_LEVELS = {
            '1': { label: '極度友好', color: '#2563eb', distance: 100, width: 4, dashed: "0" },
            '2': { label: '非常友好', color: '#0ea5e9', distance: 120, width: 3.5, dashed: "0" },
            '3': { label: '友好',    color: '#10b981', distance: 150, width: 3, dashed: "0" },
            '4': { label: '微友好',  color: '#84cc16', distance: 180, width: 2.5, dashed: "0" },
            '5': { label: '中立/競合', color: '#eab308', distance: 210, width: 2, dashed: "0" },
            '6': { label: '微敵對',  color: '#f59e0b', distance: 240, width: 2, dashed: "0" },
            '7': { label: '敵對',    color: '#f97316', distance: 280, width: 2.5, dashed: "0" },
            '8': { label: '非常敵對', color: '#ea580c', distance: 320, width: 3, dashed: "0" },
            '9': { label: '極度敵對', color: '#dc2626', distance: 380, width: 3.5, dashed: "0" }, 
            '10':{ label: '世仇',    color: '#7f1d1d', distance: 450, width: 4, dashed: "0" }
        };

        const LEGACY_MAPPING = { 'FRIENDLY': '2', 'COOPERATIVE': '5', 'HOSTILE': '8' };

        const INITIAL_DATA = {
            nodes: [
                { tempId: 1, name: "賴清德", party: "DPP", x: 0, y: 0 },
                { tempId: 2, name: "蕭美琴", party: "DPP", x: 120, y: -60 },
                { tempId: 3, name: "韓國瑜", party: "KMT", x: -120, y: 80 },
                { tempId: 4, name: "柯文哲", party: "TPP", x: 80, y: 120 },
                { tempId: 5, name: "卓榮泰", party: "DPP", x: 60, y: -120 },
                { tempId: 6, name: "黃國昌", party: "TPP", x: 140, y: 160 },
                { tempId: 7, name: "盧秀燕", party: "KMT", x: -160, y: 40 },
                { tempId: 8, name: "王世堅", party: "DPP", x: -50, y: 150 },
            ],
            links: [
                { source: 1, target: 2, type: "1", reason: "長期政治盟友" }, 
                { source: 1, target: 5, type: "2", reason: "黨內合作" }, 
                { source: 1, target: 3, type: "8", reason: "政黨立場對立" }, 
                { source: 1, target: 4, type: "9", reason: "多次公開交鋒" }, 
                { source: 4, target: 6, type: "2", reason: "議題合作" }, 
                { source: 3, target: 7, type: "3", reason: "同黨互助" }, 
                { source: 3, target: 4, type: "5", reason: "立院議題競合" }, 
                { source: 4, target: 8, type: "10", reason: "多年宿怨" },
                { source: 1, target: 8, type: "3", reason: "同黨同志" }, 
            ]
        };

        const Icon = ({ d, size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Icons = {
            Plus: (p) => <Icon {...p} d="M12 5v14M5 12h14" />,
            Link: (p) => <Icon {...p} d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
            Trash: (p) => <Icon {...p} d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Menu: (p) => <Icon {...p} d="M3 12h18M3 6h18M3 18h18" />,
            Search: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
            Cloud: (p) => <Icon {...p} d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />,
            Database: (p) => <Icon {...p} d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M21 12c0-1.66-4-3-9-3s-9 1.34-9 3m0-6C3 9 3 5 12 5s9 4 9 4M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />,
            Download: (p) => <Icon {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            List: (p) => <Icon {...p} d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
            ZoomIn: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />,
            ZoomOut: (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM7 10h6" />,
            Refresh: (p) => <Icon {...p} d="M1 4v6h6M23 20v-6h-6M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />,
            Move: (p) => <Icon {...p} d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M9 19l3 3 3 3M2 12h20M12 2v20" />,
            Star: (p) => <Icon {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
            Alert: (p) => <Icon {...p} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />,
            Edit: (p) => <Icon {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
            Message: (p) => <Icon {...p} d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />,
            History: (p) => <Icon {...p} d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />,
            ChevronDown: (p) => <Icon {...p} d="M6 9l6 6 6-6" />,
            ArrowLeft: (p) => <Icon {...p} d="M19 12H5 M12 19l-7-7 7-7" />,
            Eye: (p) => <Icon {...p} d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
            Users: (p) => <Icon {...p} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
            InfoCircle: (p) => <Icon {...p} d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 16v-4M12 8h.01" />,
            Lock: (p) => <Icon {...p} d="M19 11H5m14 0a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2m14 0V9a7 7 0 0 0-14 0v2" />,
            Unlock: (p) => <Icon {...p} d="M7 11V7a5 5 0 0 1 9.9-1 M19 11H5m14 0a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2" /> 
        };

        // --- Custom UI Components ---
        const Notification = ({ message, type, onClose }) => (
            <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[60] px-4 py-2 rounded-lg shadow-lg text-white text-sm font-bold flex items-center gap-2 slide-in ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'}`}>
                {type === 'error' && <Icons.Alert size={16}/>}
                <span>{message}</span>
                <button onClick={onClose} className="ml-2 opacity-80 hover:opacity-100"><Icons.X size={14}/></button>
            </div>
        );

        const PasswordModal = ({ onConfirm, onCancel }) => {
            const [inputPwd, setInputPwd] = useState("");
            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(inputPwd.trim());
            };
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">輸入管理員密碼</h3>
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="password" 
                                value={inputPwd} 
                                onChange={e => setInputPwd(e.target.value)} 
                                className="w-full p-2 border border-slate-300 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="請輸入密碼"
                                autoFocus
                            />
                            <div className="flex gap-3">
                                <button type="button" onClick={onCancel} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-bold text-sm transition-colors">取消</button>
                                <button type="submit" className="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition-colors">解鎖</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 fade-in">
                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 border border-slate-200">
                    <h3 className="text-lg font-bold text-slate-800 mb-2">確認操作</h3>
                    <p className="text-slate-600 text-sm mb-6">{message}</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-bold text-sm transition-colors">取消</button>
                        <button onClick={onConfirm} className="flex-1 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-sm transition-colors shadow-lg shadow-red-200">確定執行</button>
                    </div>
                </div>
            </div>
        );

        const WelcomeModal = ({ onComplete }) => {
            const [tempNickname, setTempNickname] = useState(localStorage.getItem("user_nickname") || "");
            const handleSubmit = (e) => { e.preventDefault(); if (tempNickname.trim()) onComplete(tempNickname.trim()); };
            return (
                <div className="fixed inset-0 z-[55] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 border border-slate-200">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Star size={32} className="text-blue-600" /></div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">歡迎來到台灣政治網絡</h2>
                            <p className="text-slate-600 text-sm leading-relaxed text-justify bg-slate-50 p-4 rounded-lg border border-slate-100">「即將轉職位的大叔國內政治官最後的逆襲，歡迎大家一起協作此國內政治的網絡，拓展我們對台灣政治的理解，解析其瘋狂、有趣及瞬息萬變。請善用備註，謝謝大家！」</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">請輸入您的暱稱 (將顯示於變更紀錄中)</label><input type="text" value={tempNickname} onChange={(e) => setTempNickname(e.target.value)} placeholder="例: 鍵盤觀察家" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold" autoFocus /></div>
                            <button type="submit" disabled={!tempNickname.trim()} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">開始協作</button>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const isConfigValid = useMemo(() => firebaseConfig && firebaseConfig.apiKey, []);
            const [user, setUser] = useState(null);
            const [nickname, setNickname] = useState(localStorage.getItem("user_nickname") || "");
            const [showWelcome, setShowWelcome] = useState(true);
            const [notification, setNotification] = useState(null);
            const [confirmDialog, setConfirmDialog] = useState(null);
            
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [isEditMode, setIsEditMode] = useState(false);

            const [nodes, setNodes] = useState([]);
            const [links, setLinks] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const isMobile = useMemo(() => window.innerWidth < 768, []);
            const [activeTab, setActiveTab] = useState('add_person');
            const [leftSidebarOpen, setLeftSidebarOpen] = useState(!isMobile);
            const [rightSidebarOpen, setRightSidebarOpen] = useState(false);
            const [rightSidebarMode, setRightSidebarMode] = useState('LIST'); 
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            const [searchTerm, setSearchTerm] = useState("");
            const [scale, setScale] = useState(isMobile ? 0.6 : 1);
            const [offset, setOffset] = useState({ x: window.innerWidth/2, y: window.innerHeight/2 });
            const [isPanning, setIsPanning] = useState(false);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [selectedLinkId, setSelectedLinkId] = useState(null);
            const [viewCount, setViewCount] = useState(0);

            const [newName, setNewName] = useState("");
            const [newParty, setNewParty] = useState("DPP");
            const [linkSource, setLinkSource] = useState("");
            const [linkTarget, setLinkTarget] = useState("");
            const [linkType, setLinkType] = useState("5"); 
            const [linkReason, setLinkReason] = useState(""); 

            const svgRef = useRef(null);
            const draggingRef = useRef(null);
            const panRef = useRef(null);
            const hasAutoSeededRef = useRef(false);
            const hasViewCountedRef = useRef(false);

            const showNotification = (msg, type='info') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification(null), 4000);
            };
            const handleNicknameSubmit = (name) => { setNickname(name); localStorage.setItem("user_nickname", name); setShowWelcome(false); };

            const toggleEditMode = () => {
                if (isEditMode) {
                    setIsEditMode(false);
                    showNotification("已切換至瀏覽模式 (唯讀)");
                } else {
                    setShowPasswordModal(true); 
                }
            };

            const handlePasswordSubmit = (pwd) => {
                if (pwd.trim() === "0921") {
                    setIsEditMode(true);
                    showNotification("已啟用編輯模式", "success");
                    setShowPasswordModal(false);
                } else {
                    showNotification("密碼錯誤", "error");
                }
            };

            useEffect(() => {
                if (!isConfigValid) return;
                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await auth.signInWithCustomToken(__initial_auth_token); } 
                        else { await auth.signInAnonymously(); }
                    } catch (error) { console.error("Auth error", error); showNotification("登入失敗: " + error.message, 'error'); }
                };
                init();
                return auth.onAuthStateChanged(u => setUser(u));
            }, [isConfigValid]);

            useEffect(() => {
                if (!user || hasViewCountedRef.current) return;
                hasViewCountedRef.current = true;
                const metaRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('metadata').doc('stats');
                metaRef.update({ viewCount: firebase.firestore.FieldValue.increment(1) }).catch(err => { if (err.code === 'not-found') metaRef.set({ viewCount: 1 }); });
                return metaRef.onSnapshot(doc => { if (doc.exists) setViewCount(doc.data().viewCount || 0); });
            }, [user]);

            const seedDatabase = async () => {
                if (hasAutoSeededRef.current) return;
                hasAutoSeededRef.current = true;
                const batch = db.batch();
                const nodesRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes');
                const linksRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links');
                const idMap = {}; 
                try {
                    INITIAL_DATA.nodes.forEach(n => {
                        const docRef = nodesRef.doc(); idMap[n.tempId] = docRef.id;
                        batch.set(docRef, { name: n.name, party: n.party, x: n.x, y: n.y, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    INITIAL_DATA.links.forEach(l => {
                        const docRef = linksRef.doc();
                        const initialHistory = [{ type: l.type, reason: l.reason || "初始資料", editor: "System", timestamp: new Date().toISOString() }];
                        batch.set(docRef, { source: idMap[l.source], target: idMap[l.target], type: l.type, reason: l.reason || "", history: initialHistory, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    await batch.commit();
                } catch (err) { console.error(err); }
            };

            useEffect(() => {
                if (!user) return;
                const unsubscribeNodes = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes')
                    .onSnapshot(snapshot => {
                        if (snapshot.empty && !hasAutoSeededRef.current) { seedDatabase(); return; }
                        const loadedNodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setNodes(prevNodes => loadedNodes.map(loaded => {
                            const existing = prevNodes.find(p => p.id === loaded.id);
                            return { ...loaded, x: existing ? existing.x : (loaded.x || (Math.random()-0.5)*200), y: existing ? existing.y : (loaded.y || (Math.random()-0.5)*200), vx: existing ? existing.vx : 0, vy: existing ? existing.vy : 0, radius: 15 };
                        }));
                        setLoading(false);
                        if (loadedNodes.length > 0 && !linkSource) setLinkSource(loadedNodes[0].id);
                    }, err => { console.error(err); showNotification("資料讀取失敗，請檢查權限", 'error'); });

                const unsubscribeLinks = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links')
                    .onSnapshot(snapshot => setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => { unsubscribeNodes(); unsubscribeLinks(); };
            }, [user]);

            const existingLink = useMemo(() => {
                if (!linkSource || !linkTarget || linkSource === linkTarget) return null;
                return links.find(l => (l.source === linkSource && l.target === linkTarget) || (l.source === linkTarget && l.target === linkSource));
            }, [linkSource, linkTarget, links]);

            useEffect(() => {
                if (existingLink) {
                    setLinkType(LEGACY_MAPPING[existingLink.type] || existingLink.type || "5");
                    setLinkReason(existingLink.reason || "");
                } else { setLinkReason(""); }
            }, [existingLink]);

            useEffect(() => {
                let animationFrameId;
                const linkCounts = {};
                links.forEach(l => { linkCounts[l.source] = (linkCounts[l.source]||0)+1; linkCounts[l.target] = (linkCounts[l.target]||0)+1; });
                const maxLinks = Math.max(...Object.values(linkCounts), 1);
                const MIN_RADIUS = 20; const MAX_RADIUS = 80;
                const step = () => {
                    setNodes(currentNodes => {
                        const newNodes = currentNodes.map(n => ({ ...n }));
                        const forces = newNodes.map(() => ({ fx: 0, fy: 0 }));
                        newNodes.forEach(n => {
                            const count = linkCounts[n.id] || 0;
                            const ratio = maxLinks > 0 ? count / maxLinks : 0;
                            n.radius = MIN_RADIUS + (ratio * (MAX_RADIUS - MIN_RADIUS));
                        });
                        for (let i = 0; i < newNodes.length; i++) {
                            for (let j = i + 1; j < newNodes.length; j++) {
                                const dx = newNodes[i].x - newNodes[j].x;
                                const dy = newNodes[i].y - newNodes[j].y;
                                let distSq = dx * dx + dy * dy || 1;
                                const dist = Math.sqrt(distSq);
                                const force = 35000 / distSq;
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;
                                forces[i].fx += fx; forces[i].fy += fy;
                                forces[j].fx -= fx; forces[j].fy -= fy;
                            }
                        }
                        links.forEach(link => {
                            const sIdx = newNodes.findIndex(n => n.id === link.source);
                            const tIdx = newNodes.findIndex(n => n.id === link.target);
                            if (sIdx !== -1 && tIdx !== -1) {
                                const typeKey = LEGACY_MAPPING[link.type] || link.type || "5";
                                const rel = RELATIONSHIP_LEVELS[typeKey] || RELATIONSHIP_LEVELS["5"];
                                const dx = newNodes[tIdx].x - newNodes[sIdx].x;
                                const dy = newNodes[tIdx].y - newNodes[sIdx].y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const combinedRadius = newNodes[sIdx].radius + newNodes[tIdx].radius;
                                const targetDist = Math.max(rel.distance, combinedRadius * 1.2);
                                const force = (dist - targetDist) * 0.08;
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;
                                forces[sIdx].fx += fx; forces[sIdx].fy += fy;
                                forces[tIdx].fx -= fx; forces[tIdx].fy -= fy;
                            }
                        });
                        newNodes.forEach((node, i) => {
                            if (draggingRef.current && draggingRef.current.id === node.id) {
                                if (typeof draggingRef.current.x === 'number') { node.x = draggingRef.current.x; node.y = draggingRef.current.y; }
                                node.vx = 0; node.vy = 0;
                            } else {
                                forces[i].fx -= node.x * 0.01; forces[i].fy -= node.y * 0.01;
                                node.vx = (node.vx + forces[i].fx) * 0.85; node.vy = (node.vy + forces[i].fy) * 0.85;
                                node.x += node.vx; node.y += node.vy;
                            }
                        });
                        return newNodes;
                    });
                    animationFrameId = requestAnimationFrame(step);
                };
                animationFrameId = requestAnimationFrame(step);
                return () => cancelAnimationFrame(animationFrameId);
            }, [links, nodes.length]);

            const handleAddNode = async (e) => {
                e.preventDefault();
                if(!isEditMode) return; 
                if (!newName.trim() || !user) return;
                if (nodes.length > 0 && !linkSource) { showNotification("請選擇連結對象", 'error'); return; }
                const isDuplicate = nodes.some(n => n.name === newName.trim());
                if (isDuplicate) { showNotification(`人物「${newName}」已存在！`, 'error'); setActiveTab('add_link'); return; }
                try {
                    const sourceNode = nodes.find(n => n.id === linkSource);
                    const startX = sourceNode ? sourceNode.x + (Math.random()-0.5)*50 : 0;
                    const startY = sourceNode ? sourceNode.y + (Math.random()-0.5)*50 : 0;
                    const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').add({
                        name: newName.trim(), party: newParty, x: startX, y: startY, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    if (linkSource) {
                        const logEntry = { type: linkType, reason: linkReason, editor: nickname, timestamp: new Date().toISOString() };
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').add({
                            source: linkSource, target: docRef.id, type: linkType, reason: linkReason, history: [logEntry], createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    setNewName(""); setLinkSource(docRef.id); setLinkReason("");
                    if (window.innerWidth < 768) setLeftSidebarOpen(false);
                    showNotification("人物新增成功");
                } catch (err) { console.error(err); showNotification("新增失敗: " + err.message, 'error'); }
            };

            const handleSaveLink = async (e) => {
                e.preventDefault();
                if(!isEditMode) return; 
                if (!linkSource || !linkTarget || linkSource === linkTarget) { showNotification("請選擇兩個不同的人物", 'error'); return; }
                const linksRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links');
                const logEntry = { type: linkType, reason: linkReason, editor: nickname, timestamp: new Date().toISOString() };
                try {
                    if (existingLink) {
                        await linksRef.doc(existingLink.id).update({ type: linkType, reason: linkReason, history: firebase.firestore.FieldValue.arrayUnion(logEntry), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showNotification("關係更新成功");
                    } else {
                        await linksRef.add({ source: linkSource, target: linkTarget, type: linkType, reason: linkReason, history: [logEntry], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showNotification("連結建立成功");
                    }
                    setLinkReason("");
                    if (window.innerWidth < 768) setLeftSidebarOpen(false);
                } catch (err) { console.error(err); showNotification("操作失敗: " + err.message, 'error'); }
            };

            const deleteLinkAction = async () => {
                if(!isEditMode) return; 
                try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').doc(existingLink.id).delete(); setConfirmDialog(null); showNotification("連結已刪除"); } 
                catch (err) { console.error(err); showNotification("刪除失敗: " + err.message, 'error'); }
            };

            const deleteNodeAction = async (id) => {
                if(!isEditMode) return; 
                try {
                    const batch = db.batch();
                    batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').doc(id));
                    links.filter(l => l.source === id || l.target === id).forEach(l => {
                        batch.delete(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_links').doc(l.id));
                    });
                    await batch.commit();
                    setSelectedNodeId(null);
                    setRightSidebarOpen(false);
                    setConfirmDialog(null);
                    showNotification("人物已刪除");
                } catch (err) { console.error(err); showNotification("刪除失敗: " + err.message, 'error'); }
            };

            const startDragNode = (id, clientX, clientY) => {
                draggingRef.current = { id, startX: clientX, startY: clientY, nodeX: nodes.find(n => n.id === id).x, nodeY: nodes.find(n => n.id === id).y, x: nodes.find(n => n.id === id).x, y: nodes.find(n => n.id === id).y };
                setSelectedNodeId(id);
                setRightSidebarMode('DETAILS');
                setRightSidebarOpen(true);
            };
            const startPanCanvas = (clientX, clientY) => {
                setIsPanning(true);
                panRef.current = { startX: clientX, startY: clientY, startOffsetX: offset.x, startOffsetY: offset.y };
            };
            const handleMouseDown = (e, node) => { e.stopPropagation(); startDragNode(node.id, e.clientX, e.clientY); };
            const handleCanvasMouseDown = (e) => { startPanCanvas(e.clientX, e.clientY); };
            const handleTouchStartNode = (e, node) => { e.stopPropagation(); const touch = e.touches[0]; startDragNode(node.id, touch.clientX, touch.clientY); };
            const handleCanvasTouchStart = (e) => { const touch = e.touches[0]; startPanCanvas(touch.clientX, touch.clientY); };
            const handleLinkClick = (e, link) => { e.stopPropagation(); setSelectedLinkId(link.id); setSelectedNodeId(null); setRightSidebarMode('LINK_DETAILS'); setRightSidebarOpen(true); };

            useEffect(() => {
                const handleMove = (clientX, clientY) => {
                    if (draggingRef.current) {
                        const dx = (clientX - draggingRef.current.startX) / scale;
                        const dy = (clientY - draggingRef.current.startY) / scale;
                        draggingRef.current.x = draggingRef.current.nodeX + dx;
                        draggingRef.current.y = draggingRef.current.nodeY + dy;
                    } else if (panRef.current) {
                        const dx = clientX - panRef.current.startX;
                        const dy = clientY - panRef.current.startY;
                        setOffset({ x: panRef.current.startOffsetX + dx, y: panRef.current.startOffsetY + dy });
                    }
                };
                const handleUp = async () => {
                    if (draggingRef.current) {
                        // Only save position to DB if in Edit Mode
                        if (isEditMode) {
                            const { id, x, y } = draggingRef.current;
                            if (id && !isNaN(x) && !isNaN(y)) {
                                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('political_nodes').doc(id).update({ x, y }).catch(console.error);
                            }
                        }
                        draggingRef.current = null;
                    }
                    panRef.current = null;
                    setIsPanning(false);
                };
                const onMouseMove = (e) => handleMove(e.clientX, e.clientY);
                const onMouseUp = () => handleUp();
                const onTouchMove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY);
                const onTouchEnd = () => handleUp();
                window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp);
                window.addEventListener('touchmove', onTouchMove); window.addEventListener('touchend', onTouchEnd);
                return () => { window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); window.removeEventListener('touchmove', onTouchMove); window.removeEventListener('touchend', onTouchEnd); };
            }, [scale, offset, nodes, isEditMode]);

            const zoomIn = () => setScale(s => Math.min(s * 1.2, 5));
            const zoomOut = () => setScale(s => Math.max(s / 1.2, 0.1));
            const resetView = () => { setScale(isMobile ? 0.6 : 1); setOffset({ x: window.innerWidth/2, y: window.innerHeight/2 }); };
            const sortedNodes = useMemo(() => [...nodes].sort((a,b) => a.name.localeCompare(b.name)), [nodes]);

            if (!isConfigValid) return (
                <div className="w-full h-screen flex items-center justify-center bg-red-50 p-5">
                    <div className="max-w-md bg-white p-8 rounded-xl shadow-xl border border-red-200 text-center">
                        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Alert size={32} className="text-red-500" /></div>
                        <h2 className="text-2xl font-bold text-red-800 mb-2">尚未設定資料庫連線</h2>
                        <p className="text-gray-600 mb-6 text-sm leading-relaxed">請使用文字編輯器打開此 HTML 檔案，並填入您的 <code>const firebaseConfig</code>。</p>
                    </div>
                </div>
            );

            const currentRelLevel = RELATIONSHIP_LEVELS[linkType] || RELATIONSHIP_LEVELS['5'];

            return (
                <div className="flex h-screen w-full bg-slate-50 overflow-hidden font-sans text-slate-800">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    {confirmDialog && <ConfirmModal message={confirmDialog.message} onConfirm={confirmDialog.onConfirm} onCancel={() => setConfirmDialog(null)} />}
                    {showPasswordModal && <PasswordModal onConfirm={handlePasswordSubmit} onCancel={() => setShowPasswordModal(false)} />}
                    {showWelcome && <WelcomeModal onComplete={handleNicknameSubmit} />}
                    
                    {/* Header / Left Sidebar */}
                    <div className={`absolute z-30 left-0 top-0 h-full shadow-2xl transition-transform duration-300 flex flex-col glass-panel border-r border-slate-200 w-full sm:w-80 ${leftSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md shrink-0">
                            <h1 className="font-bold text-lg flex items-center gap-2"><Icons.Cloud size={20}/> 雲端政壇觀測</h1>
                            <div className="flex items-center gap-3">
                                <button onClick={toggleEditMode} className={`p-1.5 rounded-lg transition-colors ${isEditMode ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`} title={isEditMode ? "目前為編輯模式 (點擊鎖定)" : "目前為唯讀模式 (點擊解鎖)"}>
                                    {isEditMode ? <Icons.Unlock size={18}/> : <Icons.Lock size={18}/>}
                                </button>
                                <button onClick={() => setLeftSidebarOpen(false)} className="hover:bg-slate-700 p-1.5 rounded"><Icons.X size={24}/></button>
                            </div>
                        </div>

                        {/* Controls / Forms - Only visible in Edit Mode or simplified view */}
                        {!isEditMode ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-400 p-6 text-center space-y-4">
                                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center"><Icons.Lock size={32}/></div>
                                <div>
                                    <h3 className="text-lg font-bold text-slate-600">唯讀模式</h3>
                                    <p className="text-xs mt-2">目前僅供瀏覽。如需新增人物或編輯關係，請點擊上方鎖頭解鎖。</p>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div className="flex p-2 gap-2 bg-slate-100 border-b border-slate-200 shrink-0">
                                    <button onClick={() => setActiveTab('add_person')} className={`flex-1 py-3 sm:py-2 text-xs font-bold rounded flex items-center justify-center gap-1 ${activeTab === 'add_person' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}><Icons.Plus size={16}/> 新增人物</button>
                                    <button onClick={() => setActiveTab('add_link')} className={`flex-1 py-3 sm:py-2 text-xs font-bold rounded flex items-center justify-center gap-1 ${activeTab === 'add_link' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}><Icons.Link size={16}/> 連結 / 編輯</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-6 pb-20 sm:pb-4">
                                    {activeTab === 'add_person' && (
                                        <form onSubmit={handleAddNode} className="space-y-4 fade-in">
                                            <div><label className="text-xs font-bold text-slate-400 mb-1 block">新人物姓名</label><input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="例: 王世堅" className="w-full p-3 sm:p-2 rounded border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-base sm:text-sm" /></div>
                                            <div><label className="text-xs font-bold text-slate-400 mb-1 block">所屬政黨</label><div className="grid grid-cols-2 gap-2">{Object.entries(PARTIES).map(([k, v]) => (<button type="button" key={k} onClick={() => setNewParty(k)} className={`text-xs py-2 px-2 rounded border ${newParty === k ? 'ring-2 ring-offset-1 font-bold' : 'opacity-70'}`} style={{ backgroundColor: newParty === k ? v.color : '#fff', color: newParty === k ? '#fff' : '#333', borderColor: v.color }}>{v.label}</button>))}</div></div>
                                            {nodes.length > 0 ? (
                                                <div className="p-3 bg-blue-50 rounded border border-blue-100">
                                                    <label className="text-xs font-bold text-blue-800 mb-1 block">初始連結對象</label>
                                                    <select value={linkSource} onChange={e => setLinkSource(e.target.value)} className="w-full p-3 sm:p-2 mb-3 rounded border border-blue-200 text-base sm:text-sm"><option value="" disabled>-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}</select>
                                                    <div><label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between"><span>關係光譜: <span style={{color: currentRelLevel.color}}>{currentRelLevel.label}</span></span><span style={{color: currentRelLevel.color}}>●</span></label><input type="range" min="1" max="10" value={linkType} onChange={e => setLinkType(e.target.value)} /></div>
                                                    <div className="mt-3"><label className="text-xs font-bold text-blue-800 mb-1 block">相關新聞 / 變更原因</label><textarea value={linkReason} onChange={e => setLinkReason(e.target.value)} placeholder="紀錄原因 (選填)..." className="w-full p-2 rounded border border-blue-200 text-xs h-16 outline-none resize-none"></textarea></div>
                                                </div>
                                            ) : <div className="p-3 bg-green-50 rounded border border-green-200 text-green-800 text-xs font-bold mb-2 flex items-center gap-2"><Icons.Star size={16} className="text-green-600"/><span>第一位核心人物</span></div>}
                                            <button type="submit" disabled={!newName.trim() || (nodes.length > 0 && !linkSource)} className="w-full py-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:opacity-50 font-bold text-base">{nodes.length === 0 ? "建立起點" : "加入網絡"}</button>
                                        </form>
                                    )}
                                    {activeTab === 'add_link' && (
                                        <form onSubmit={handleSaveLink} className="space-y-4 fade-in">
                                            {nodes.length < 2 ? <div className="p-4 text-center text-slate-400 text-xs">需至少兩位人物</div> : (
                                                <div className={`p-4 rounded border space-y-3 transition-colors ${existingLink ? 'bg-amber-50 border-amber-200' : 'bg-purple-50 border-purple-100'}`}>
                                                    {existingLink && <div className="text-xs font-bold text-amber-600 flex items-center gap-2 mb-2 border-b border-amber-200 pb-2"><Icons.Edit size={14} /> 編輯現有關係</div>}
                                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">人物 A</label><select value={linkSource} onChange={e => setLinkSource(e.target.value)} className="w-full p-3 sm:p-2 rounded border border-slate-200 text-base sm:text-sm"><option value="">-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id} disabled={n.id === linkTarget}>{n.name}</option>)}</select></div>
                                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">人物 B</label><select value={linkTarget} onChange={e => setLinkTarget(e.target.value)} className="w-full p-3 sm:p-2 rounded border border-slate-200 text-base sm:text-sm"><option value="">-- 選擇 --</option>{sortedNodes.map(n => <option key={n.id} value={n.id} disabled={n.id === linkSource}>{n.name}</option>)}</select></div>
                                                    <div className="pt-2"><label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between"><span>關係光譜: <span style={{color: currentRelLevel.color}}>{currentRelLevel.label}</span></span></label><input type="range" min="1" max="10" value={linkType} onChange={e => setLinkType(e.target.value)} /></div>
                                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">變更原因 / 相關新聞</label><textarea value={linkReason} onChange={e => setLinkReason(e.target.value)} placeholder="紀錄變更原因 (選填)..." className="w-full p-2 rounded border border-slate-200 text-xs h-16 outline-none resize-none"></textarea></div>
                                                </div>
                                            )}
                                            <div className="flex gap-2">
                                                {existingLink && <button type="button" onClick={() => setConfirmDialog({message: "確定要解除這段關係嗎？", onConfirm: deleteLinkAction})} className="flex-1 py-3 bg-red-100 text-red-600 hover:bg-red-200 rounded shadow font-bold text-base flex items-center justify-center gap-1"><Icons.Trash size={18}/> 刪除</button>}
                                                <button type="submit" disabled={!linkSource || !linkTarget} className={`flex-[2] py-3 text-white rounded shadow font-bold text-base disabled:opacity-50 ${existingLink ? 'bg-amber-500 hover:bg-amber-600' : 'bg-purple-600 hover:bg-purple-700'}`}>{existingLink ? "更新關係" : "建立連結"}</button>
                                            </div>
                                        </form>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                    {!leftSidebarOpen && <button onClick={() => { setLeftSidebarOpen(true); setRightSidebarOpen(false); }} className="absolute top-4 left-4 z-20 bg-white p-3 rounded shadow-lg border border-slate-100 active:bg-slate-100"><Icons.Menu size={24} /></button>}
                    
                    {/* Right Sidebar */}
                    <div className={`absolute z-30 right-0 top-0 h-full shadow-xl transition-transform duration-300 flex flex-col glass-panel border-l border-slate-200 w-full sm:w-64 ${rightSidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="p-3 bg-slate-800 text-white flex justify-between items-center shadow-sm shrink-0">
                            <h2 className="font-bold text-sm flex items-center gap-2">
                                {(selectedNodeId) ? <><Icons.Users size={16}/> 人物檔案與歷史</> : (selectedLinkId ? <><Icons.InfoCircle size={16}/> 關係詳情</> : <><Icons.List size={16}/> 人物名單 ({nodes.length})</>)}
                            </h2>
                            <button onClick={() => setRightSidebarOpen(false)} className="hover:bg-slate-700 p-2 rounded"><Icons.X size={24}/></button>
                        </div>

                        {selectedNodeId && (
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4 pb-20">
                                <button onClick={() => { setSelectedNodeId(null); }} className="text-blue-600 text-xs flex items-center gap-1 mb-2 hover:underline"><Icons.ArrowLeft size={12}/> 返回名單</button>
                                {nodes.find(n => n.id === selectedNodeId) && (
                                    <>
                                        <div className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm text-center">
                                            <div className="text-3xl font-bold mb-2 text-slate-800">{nodes.find(n => n.id === selectedNodeId).name}</div>
                                            <span className="inline-block px-3 py-1 rounded-full text-white text-xs font-bold" style={{backgroundColor: PARTIES[nodes.find(n => n.id === selectedNodeId).party]?.color}}>{PARTIES[nodes.find(n => n.id === selectedNodeId).party]?.label}</span>
                                            {isEditMode && (
                                                <div className="mt-4 flex justify-center">
                                                    <button onClick={() => setConfirmDialog({message: "確定要刪除此人物？相關連結也會一併移除。", onConfirm: () => deleteNodeAction(selectedNodeId)})} className="text-red-500 text-xs flex items-center gap-1 hover:bg-red-50 px-2 py-1 rounded"><Icons.Trash size={12}/> 刪除人物</button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="space-y-3">
                                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b pb-1">連結關係與歷史</h4>
                                            {links.filter(l => l.source === selectedNodeId || l.target === selectedNodeId).map(link => {
                                                const isSource = link.source === selectedNodeId;
                                                const otherNode = nodes.find(n => n.id === (isSource ? link.target : link.source));
                                                const typeKey = LEGACY_MAPPING[link.type] || link.type || "5";
                                                const rel = RELATIONSHIP_LEVELS[typeKey] || RELATIONSHIP_LEVELS["5"];
                                                if (!otherNode) return null;
                                                return (
                                                    <div key={link.id} className="bg-white rounded-lg border border-slate-100 shadow-sm overflow-hidden">
                                                        <div className="p-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors" onClick={() => setExpandedHistoryId(expandedHistoryId === link.id ? null : link.id)}>
                                                            <div className="font-bold text-sm flex items-center gap-2"><span>{otherNode.name}</span><span className="text-[10px] px-1.5 py-0.5 rounded-full text-white" style={{backgroundColor: rel.color}}>{rel.label}</span></div>
                                                            <Icons.ChevronDown size={16} className={`text-slate-400 transition-transform ${expandedHistoryId === link.id ? 'rotate-180' : ''}`} />
                                                        </div>
                                                        {expandedHistoryId === link.id && (
                                                            <div className="bg-slate-50 p-3 text-xs border-t border-slate-100 animate-fade-in">
                                                                <div className="mb-2 font-bold text-slate-500">目前狀態備註:</div>
                                                                <div className="mb-3 p-2 bg-white rounded border border-slate-200 text-slate-700">{link.reason || "無備註"}</div>
                                                                {link.history && link.history.length > 0 && (
                                                                    <div className="space-y-3 mt-3 pt-3 border-t border-slate-200">
                                                                        <div className="font-bold text-[10px] text-slate-400 uppercase">變更歷史</div>
                                                                        {link.history.slice().reverse().map((h, idx) => (
                                                                            <div key={idx} className="pl-3 border-l-2 border-slate-300 relative">
                                                                                <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span className="font-bold text-slate-600">{h.editor || "Unknown"}</span><span>{new Date(h.timestamp).toLocaleDateString()}</span></div>
                                                                                <div className="text-slate-700"><span className="font-bold" style={{color: (RELATIONSHIP_LEVELS[h.type] || {}).color}}>[{(RELATIONSHIP_LEVELS[h.type] || {label: '未知'}).label}]</span> {h.reason}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {links.filter(l => l.source === selectedNodeId || l.target === selectedNodeId).length === 0 && <div className="text-center text-slate-400 text-xs py-4">此人尚無連結</div>}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {selectedLinkId && !selectedNodeId && (
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4 pb-20">
                                <button onClick={() => { setSelectedLinkId(null); }} className="text-blue-600 text-xs flex items-center gap-1 mb-2 hover:underline"><Icons.ArrowLeft size={12}/> 返回名單</button>
                                {(() => {
                                    const link = links.find(l => l.id === selectedLinkId);
                                    if (!link) return <div className="text-slate-400">連結已不存在</div>;
                                    const sourceNode = nodes.find(n => n.id === link.source);
                                    const targetNode = nodes.find(n => n.id === link.target);
                                    const typeKey = LEGACY_MAPPING[link.type] || link.type || "5";
                                    const rel = RELATIONSHIP_LEVELS[typeKey] || RELATIONSHIP_LEVELS["5"];
                                    
                                    return (
                                        <>
                                            <div className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
                                                <div className="flex items-center justify-center gap-3 mb-2">
                                                    <div className="text-lg font-bold text-slate-700">{sourceNode?.name}</div>
                                                    <div className="text-slate-300">↔</div>
                                                    <div className="text-lg font-bold text-slate-700">{targetNode?.name}</div>
                                                </div>
                                                <div className="text-center">
                                                    <span className="inline-block px-3 py-1 rounded-full text-white text-xs font-bold" style={{backgroundColor: rel.color}}>{rel.label}</span>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-4">
                                                <div className="mb-2 font-bold text-slate-500 text-xs">目前狀態備註:</div>
                                                <div className="p-2 bg-slate-50 rounded border border-slate-200 text-slate-700 text-sm">{link.reason || "無備註"}</div>
                                                
                                                {link.history && link.history.length > 0 && (
                                                    <div className="space-y-3 mt-4 pt-3 border-t border-slate-200">
                                                        <div className="font-bold text-[10px] text-slate-400 uppercase">變更歷史</div>
                                                        {link.history.slice().reverse().map((h, idx) => (
                                                            <div key={idx} className="pl-3 border-l-2 border-slate-300 relative">
                                                                <div className="flex justify-between text-[10px] text-slate-400 mb-1">
                                                                    <span className="font-bold text-slate-600">{h.editor || "Unknown"}</span>
                                                                    <span>{new Date(h.timestamp).toLocaleDateString()}</span>
                                                                </div>
                                                                <div className="text-slate-700 text-xs">
                                                                    <span className="font-bold" style={{color: (RELATIONSHIP_LEVELS[h.type] || {}).color}}>[{(RELATIONSHIP_LEVELS[h.type] || {label: '未知'}).label}]</span> {h.reason}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {isEditMode && (
                                                <div className="mt-4">
                                                    <button onClick={() => { 
                                                        setLinkSource(link.source); 
                                                        setLinkTarget(link.target); 
                                                        setActiveTab('add_link');
                                                        setLeftSidebarOpen(true); 
                                                        if(window.innerWidth < 768) setRightSidebarOpen(false);
                                                    }} className="w-full py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded font-bold text-xs border border-blue-200 flex items-center justify-center gap-1">
                                                        <Icons.Edit size={14}/> 編輯此關係
                                                    </button>
                                                </div>
                                            )}
                                        </>
                                    );
                                })()}
                            </div>
                        )}

                        {!selectedNodeId && !selectedLinkId && (
                            <div className="flex-1 flex flex-col h-full">
                                <div className="p-2 border-b border-slate-200 bg-slate-50 shrink-0"><div className="relative"><Icons.Search size={18} className="absolute left-3 top-3 text-slate-400"/><input type="text" placeholder="搜尋姓名..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-3 py-2 rounded border border-slate-300 text-sm focus:ring-1 focus:ring-blue-500 outline-none"/></div></div>
                                <div className="flex-1 overflow-y-auto p-2 custom-scrollbar pb-20">
                                    {Object.entries(PARTIES).map(([partyKey, partyInfo]) => {
                                        const partyNodes = sortedNodes.filter(n => n.party === partyKey && n.name.includes(searchTerm));
                                        if (partyNodes.length === 0) return null;
                                        return (
                                            <div key={partyKey} className="mb-4">
                                                <h3 className="text-[10px] font-bold text-slate-500 mb-2 px-2 flex items-center gap-1 uppercase tracking-wider"><span className="w-2 h-2 rounded-full" style={{background: partyInfo.color}}></span>{partyInfo.label}</h3>
                                                <div className="space-y-1">{partyNodes.map(node => (<div key={node.id} onClick={() => { setSelectedNodeId(node.id); setRightSidebarOpen(true); }} className={`px-3 py-2 rounded cursor-pointer flex items-center justify-between text-sm transition-colors hover:bg-slate-100 text-slate-700`}><span>{node.name}</span><span className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-400">{links.filter(l => l.source === node.id || l.target === node.id).length}</span></div>))}</div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Main Graph */}
                    <div className={`flex-1 relative overflow-hidden bg-slate-50 transition-all duration-300 ${!isMobile && rightSidebarOpen ? 'mr-80' : 'mr-0'} ${!isMobile && leftSidebarOpen ? 'ml-80' : 'ml-0'} ${isPanning ? 'cursor-grabbing' : 'cursor-grab'}`} onMouseDown={handleCanvasMouseDown} onTouchStart={handleCanvasTouchStart}>
                        <div className="absolute top-4 right-4 z-20 flex gap-2">{!rightSidebarOpen && <button onClick={() => { setRightSidebarOpen(true); setSelectedNodeId(null); setSelectedLinkId(null); }} className="bg-white p-3 rounded shadow-lg text-slate-600 active:bg-slate-100 flex items-center gap-1 text-xs font-bold"><Icons.List size={20}/> <span className="hidden sm:inline">名單</span></button>}</div>
                        <div className="absolute bottom-8 right-4 z-20 flex flex-col gap-3">
                            <div className="flex flex-col bg-white rounded-lg shadow-xl border border-slate-200 overflow-hidden">
                                <button onClick={zoomIn} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100 border-b border-slate-100"><Icons.ZoomIn size={24}/></button>
                                <button onClick={zoomOut} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100 border-b border-slate-100"><Icons.ZoomOut size={24}/></button>
                                <button onClick={resetView} className="p-3 sm:p-2 text-slate-600 active:bg-slate-100"><Icons.Refresh size={24}/></button>
                            </div>
                        </div>

                        {/* Stats & Attribution */}
                        <div className="absolute bottom-4 left-4 z-20 flex flex-col gap-1 pointer-events-none select-none">
                            <div className="bg-white/80 backdrop-blur-sm px-3 py-2 rounded-lg border border-slate-200 shadow-sm flex gap-4 text-xs text-slate-600 font-bold">
                                <span className="flex items-center gap-1"><Icons.Eye size={14} className="text-blue-500"/> 瀏覽: {viewCount}</span>
                            </div>
                        </div>
                        <div className="absolute bottom-1 right-2 text-[10px] text-slate-300 select-none pointer-events-none z-10 text-right opacity-60">由 chenalewei62 駱駝大叔以 Gemini 輔助生產</div>
                        
                        <svg ref={svgRef} className="w-full h-full" style={{touchAction: 'none'}} onWheel={e => setScale(s => Math.max(0.1, Math.min(5, e.deltaY > 0 ? s * 0.9 : s * 1.1)))}>
                            <g transform={`translate(${offset.x}, ${offset.y}) scale(${scale})`}>
                                {links.map(link => {
                                    const s = nodes.find(n => n.id === link.source);
                                    const t = nodes.find(n => n.id === link.target);
                                    if (!s || !t) return null;
                                    const typeKey = LEGACY_MAPPING[link.type] || link.type || "5";
                                    const rel = RELATIONSHIP_LEVELS[typeKey] || RELATIONSHIP_LEVELS["5"];
                                    const isDimmed = (selectedNodeId && s.id !== selectedNodeId && t.id !== selectedNodeId) || 
                                                    (selectedLinkId && link.id !== selectedLinkId);
                                    return (
                                        <g key={link.id} onClick={(e) => handleLinkClick(e, link)} className={`cursor-pointer group transition-opacity duration-300 ${isDimmed ? 'opacity-10' : 'opacity-100'}`}>
                                            <line x1={s.x} y1={s.y} x2={t.x} y2={t.y} stroke="transparent" strokeWidth="12" />
                                            <line x1={s.x} y1={s.y} x2={t.x} y2={t.y} stroke={rel.color} strokeWidth={rel.width} strokeDasharray={rel.dashed} strokeOpacity={0.7} className="transition-all group-hover:stroke-opacity-100 group-hover:stroke-width-[+2]" />
                                        </g>
                                    );
                                })}
                                {nodes.map(node => {
                                    // Dimming Logic: If a node is selected, dim all nodes that are NOT the selected node AND NOT connected to it.
                                    const isConnectedToSelected = selectedNodeId && links.some(l => (l.source === selectedNodeId && l.target === node.id) || (l.target === selectedNodeId && l.source === node.id));
                                    const isDimmed = (selectedNodeId && node.id !== selectedNodeId && !isConnectedToSelected) || (selectedLinkId && !links.find(l => l.id === selectedLinkId && (l.source === node.id || l.target === node.id)));
                                    
                                    return (
                                        <g key={node.id} transform={`translate(${node.x}, ${node.y})`} onMouseDown={e => handleMouseDown(e, node)} onTouchStart={e => handleTouchStartNode(e, node)} className={`transition-opacity duration-300 cursor-pointer ${isDimmed ? 'opacity-20' : 'opacity-100'}`}>
                                            {selectedNodeId === node.id && <circle r={node.radius + 10} fill="rgba(59, 130, 246, 0.3)" />}
                                            <circle r={node.radius} fill={PARTIES[node.party]?.color || "#999"} stroke={selectedNodeId === node.id ? "#3b82f6" : "white"} strokeWidth={selectedNodeId === node.id ? 4 : 2} className="shadow-sm" />
                                            <text dy=".3em" textAnchor="middle" fill={PARTIES[node.party]?.textColor || "#FFFFFF"} className="font-bold pointer-events-none select-none" style={{ fontSize: `${Math.max(10, node.radius / 2)}px`, textShadow: '0 1px 2px rgba(0,0,0,0.3)' }}>{node.name}</text>
                                        </g>
                                    );
                                })}
                            </g>
                        </svg>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
